---
layout: post
title: Linux Router Setup &mdash; NixOS &amp; "v6 plus" edition
keywords: linux, map-e, v6-plus, nixos
---

# Introduction

I recently moved to Tokyo. The apartment I ended up in has a fiber optic port (conventionally labeled <ruby>å…‰<rp><rt>hikari</rt></rp></ruby>, meaning "light").

(Insert image of the port)

The port's on NTT's fiber.
In contrast to America, where it's common for an apartment to be "comcast only" or "AT&amp;T only", NTT's underlying fiber is available to whatever ISPs want to use it, which meant I had plenty of options for the ISP itself.

After briefly shopping around, I picked an ISP and plan. Naturally, since I shipped my trusty [PCEngines APU2](https://www.pcengines.ch/apu2.htm) with me, I signed up for a plan that didn't come with a router.
"Are you sure? You have a router that supports IPoE and 'v6 plus', since we don't support PPPoE, right?" they asked.
Now, I had no clue what "v6 plus" was, but I was confident that Linux would support any acronym soup, so I plowed straight ahead.
In my head, I was expecting to just write the usual router config (you know,
run a dhcp server, flip on `ip_forwarding`, NAT traffic out the WAN interface,
call it a day), and then maybe flip on a "v6 plus" option somewhere in my nixos config, or at worse as an option on the dhcp client or something.

It turns out things are more complicated than I thought. It took a couple days
of fiddling around to actually get things setup. What's more, most of the
resources about the network setup involved here are in Japanese, and often
don't fully explain the reasoning for everything.

I figure it's worth writing up my understanding of this and sharing my router config in case it helps someone out there. Unfortunately, I also don't have a full understanding of all the details, so my explanations will also be lacking!

With that, let's talk about the basics of "v6 plus".

## What is v6 plus?

As best as I can tell, "v6 plus" refers to the combination of:

1. Can handle

### v6 plus

The "v6" in "v6 plus", unsurprisingly, refers to "IPv6". In fact, by default, you only get IPv6 addresses assigned to you.
However, enough of the internet needs IPv4 connectivity, and "v6 plus" addresses that.

Other solutions exist for sharing one IPv4 address among multiple customers exist, (most notably, CGNAT, the one I think is most often taken in the US), but "v6 plus" operates without a layer of NAT on the ISPs side, and so their hardware can be much simpler.

The core technology "v6 plus" is built around is an IPIP tunnel, specifically
IPv4 over IPv6. The ISP operates a server which allows customers to create
ipip6 tunnels to it, and that server doesn't have to track IPv4 connection
state, but rather just has to track enough ipip6 tunnel state to validate that
the given IPv4 address being tunneled belongs to the customer's tunnel.

https://datatracker.ietf.org/doc/html/rfc2473

In order to ensure this actually does actually help with IPv4 exhaustion (you
know, the whole point of this), each customer is only allowed to use specific
ports on specific IP addresses.

So, less state on the ISPs side, more configuration on the client's side... that sounds good, right, since you can just ship routers that do all the configuration painlessly, right? Are there other tradeoffs?

I speculate, though I may be wrong, that this methodology does have a few other
downsides. One of them is that it's more difficult to change the configured
allocation of IP addresses and ports. Since this is baked into consumer
routers, it's more likely to ossify. With a CGNAT setup, it's trivial to give
customers more or fewer IPs or ports over time, but with customer equipment
running their own tunnels, it's much harder to make a sweeping change.

This also requires consumer routers to be more complicated and support these
tunnels... which means a large swathe of existing consumer routers simply won't
work with this setup at all.

One final tradeoff is that it requires pushing significantly more configuration information down to routers through some mechanism.
Except, what if instead of pushing configuration info down, you created a way to instead embed that information in the IPv6 address you assign the router? It fits perfectly with the scheme of making routers do more work, so why not? That brings us nicely to Map-E

### Map-E

https://datatracker.ietf.org/doc/html/rfc7597

Map-E only makes sense in the context of "v6 plus", and in practice, I think
"v6 plus" implies "Map-E" as well. "Map-E" is the mechanism by which all the
details related to the ipip6 tunnel, described above, are configured.

Something very much like MAP-E is described in this [IETF
draft](https://datatracker.ietf.org/doc/html/draft-ietf-softwire-map-03). Note
well that the description there is fairly generic, and on its own won't
actually tell you how to configure your router.

The draft above references things like "Basic Mapping Rules"
